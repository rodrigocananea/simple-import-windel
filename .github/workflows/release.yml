name: Release

on:
  push:
    tags:
      - '*'

jobs:

  compile:
    name: Compilando código
    runs-on: windows-2022
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
        cache: maven
    - name: Compile code
      run: mvn -B compile

  package:
    name: Empacotar para executável
    runs-on: windows-2022
    needs: [ compile ]
    steps:
    - uses: actions/checkout@v2
    - name: Subindo JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
        cache: maven
    - name: Gerando executável
      run: mvn -B package --file pom.xml && mkdir staging && cp target/*.exe staging
    - name: Subindo executável
      uses: actions/upload-artifact@v2
      with:
        name: SimpleImport
        path: ./staging/SimpleImport.exe

  release:
      name: Liberar versão
      runs-on: windows-2022
      needs: [ package ]
      steps:
        - uses: actions/checkout@v2
        - name: Baixando executável
          uses: actions/download-artifact@master
          with:
            name: SimpleImport
            path: staging/SimpleImport.exe
        - name: Criando release
          uses: actions/create-release@v1
          id: create_release
          with:
            draft: false
            prerelease: false
            release_name: ${{ steps.version.outputs.version }}
            tag_name: ${{ github.ref }}
            body_path: CHANGELOG.md
          env:
            GITHUB_TOKEN: ${{ github.token }}
        - name: Subir executavel para release
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ github.token }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ./executavel/SimpleImport.exe
            asset_name: SimpleImport.exe
            asset_content_type: application/exe